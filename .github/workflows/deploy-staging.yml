name: Deploy to Staging Environment

on:
  pull_request:
    types: [closed]
    branches: [ staging ]

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment: staging
    # Only run if PR is merged from master to staging and ENABLE_DEPLOY flag is true (default: false)
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'staging' && github.event.pull_request.head.ref == 'master' && vars.ENABLE_DEPLOY == 'true'

    steps:
    - name: Deploy to Staging Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USERNAME }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script_stop: true
        command_timeout: 30m
        script: |
          set -Eeuo pipefail
          trap 'echo "❌ Error at line $LINENO"; exit 1' ERR

          cd /home/ubuntu/maivietland/backend
          git checkout staging
          git pull origin staging

          # Update API documentation version in .env file
          API_DOC_VERSION=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          if grep -q "^API_DOC_VERSION=" .env 2>/dev/null; then
            sed -i "s/^API_DOC_VERSION=.*/API_DOC_VERSION=$API_DOC_VERSION/" .env
          else
            echo "API_DOC_VERSION=$API_DOC_VERSION" >> .env
          fi

          export PATH="$HOME/.local/bin:$PATH"
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-root
          poetry run python manage.py migrate --noinput
          poetry run python manage.py collectstatic --noinput
          poetry run python manage.py collect_permissions
          sudo supervisorctl restart maivietland-api maivietland-worker maivietland-consume-audit-logs

    - name: Health Check (with retry)
      run: |
        set -Eeuo pipefail
        url="${{ vars.STAGING_APP_URL }}/health/"
        for i in {1..10}; do
          status=$(curl -sS -o /dev/null -w "%{http_code}" --max-time 10 "$url") || status="000"
          if [ "$status" = "200" ]; then
            echo "✅ Deploy thành công: 200 OK (attempt $i)"
            exit 0
          fi
          echo "⏳ Chưa sẵn sàng (HTTP $status) — thử lại ($i/10)"; sleep 5
        done
        echo "❌ Deploy thất bại: không nhận được 200 OK sau 10 lần thử"
        exit 1

    - name: Notify Deployment
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        text: "STAGING deployment completed with status: ${{ job.status }}"
      env:
        SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
